#!/usr/bin/perl
use strict;
use warnings;
use 5.10.0;

# run from gitolite-doc as "./mkdoc"

# my $OUTDIR = "/tmp/doc2";
my $OUTDIR = "$ENV{HOME}/imli/tech/repos/sitaramc.github.com/gitolite";
unless (@ARGV) {
    system("rm     $OUTDIR/*.html");
    system("rm -rf $OUTDIR/images");
    system("mkdir  $OUTDIR/images");
}

# collect names of all markdown files
my @mkd = `find . -name "*.mkd" | sort`;
chomp(@mkd);

# if arguments were supplied, save them, else pretend all markdown files were supplied as arguments
my @argv = @ARGV;
@argv = @mkd unless @argv;

my %linkrefs;
my $base;
my %seen;

# first round runs through all markdown files, @mkd
@ARGV = @mkd;
while (<>) {
    unless ( $seen{$ARGV}++ ) {
        # on each change of file, compute the base name...
        $base = ( $ARGV =~ m(([^/]+)\.mkd) ? $1 : '' );
        # ...and add linkref to the file
        $linkrefs{TITLE} .= "\[$base\]: $base.html\n";
    }

    # now add linkrefs for everything else
    if ( /^#+ .* \{#(\S+)( .*?)?\}/ or /^#+ #(\S+) / ) {            # XXX last clause is transition code
        $linkrefs{$base} .= "\[$1\]: $base.html\#$1\n";
    }
}

# second round runs through markdown files supplied as arguments
while (@argv) {
    $_ = shift @argv;

    m(([^/]+)\.mkd) or die "bad mkd file: '$_'";
    $base = $1;
    next if $base eq 'gitolite';                             # single page stuff needs different treatment

    open( my $mdp, "|-", "cat $_ - > pdh.temp") or die $!;
    print $mdp "\n" . linkrefs_except($base);
    close $mdp;
    system("pdh -t html-N -i pdh.temp -o $OUTDIR/$base.html" ) and warn "WARNING: '$base.html' was not created";
    print STDERR "\r    \r" . scalar(@argv);
}
print STDERR "\r    \n";

unlink "pdh.temp";
say STDERR "----";
# TODO # system("pdh -t html-N -i gitolite.mkd -o $OUTDIR/gitolite.html");

# send manually created HTML pages and images
system("cp html/*.html $OUTDIR");
system("cp images/* $OUTDIR/images");

sub linkrefs_except {
    my $base = shift;
    return join " ", map { $_ eq $base ? '' : $linkrefs{$_} } keys %linkrefs;
}
